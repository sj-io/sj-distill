---
title: "Memphis Data"
output:
    flexdashboard::flex_dashboard
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(plotly)
library(scales)
library(DT)
```

```{r message=FALSE, warning=FALSE}
acs <- read_csv("../_data/acs.csv") %>% 
  select(-dataset)
acss <- read_csv("../_data/acs_sum.csv")
v19 <- read_csv("../_data/v19acs1.csv")
v74 <- read_csv("../_data/vB25074.csv")
yr <- read_csv("../_data/year.csv")
```

```{r}
acs3 <- acss %>% 
  select(-c(summary_est, summary_moe)) %>% 
  rbind(acs)
```

# Home Values 

## Col

### B25077_001: Median Home Value

```{r}
gghsg <- acs %>%
  filter(str_detect(variable, "B25077")) %>% 
  ggplot(aes(x = year, y = estimate, group = 1)) +
  geom_ribbon(aes(ymax = estimate + moe, ymin = estimate - moe),
              fill = "navy",
              alpha = 0.4) +
  geom_line(color = "navy") +
  scale_y_continuous(labels = label_dollar(scale = .001, suffix = "K"))+
  scale_x_continuous(breaks = unique(acs$year)) +
  labs(title = "Median Home Value in Memphis, 2005-2019",
       y = "ACS estimate",
       x = "",
       color = "Dataset") +
  theme_light()

ggplotly(gghsg)
```

# Population {data-orientation=rows}

## Row 1

### B25002: Occupancy Status

```{r}
hh <- acss %>% 
  filter(str_detect(variable, "B25002_00(1|2)")) %>% 
  mutate(variable = recode_factor(variable,
                                  "B25002_001" = "Housing Units",
                                  "B25002_002" = "Households"))

ggHH <- hh %>% 
  ggplot(aes(x = year, y = estimate, color = variable, fill = variable, group = 1)) +
  geom_ribbon(aes(ymax = estimate + moe, ymin = estimate - moe),
              alpha = 0.4) +
  geom_line() +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K"))+
  scale_x_continuous(breaks = unique(hh$year)) +
  labs(title = "Households & Housing Units in Memphis, 2005-2019",
       y = "ACS estimate",
       x = "Year",
       fill = "Variable",
       color = "",
       caption = "Shaded area represents margin of error around the ACS estimate") +
  theme_light()

ggplotly(ggHH)
```

## Row 2

### B25008_001: Population in Occupied Housing Units

```{r}
pop <- acss %>% 
  filter(variable == "B25008_001")

ggpop <- pop %>% 
  ggplot(aes(x = year, y = estimate, group = 1)) +
  geom_ribbon(aes(ymax = estimate + moe, ymin = estimate - moe),
              fill = "navy",
              alpha = 0.4) +
  geom_line(color = "navy") +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K"))+
  scale_x_continuous(breaks = unique(pop$year)) +
  labs(title = "Population in Memphis, 2005-2019",
       y = "ACS estimate",
       x = "Year",
       caption = "Shaded area represents margin of error around the ACS estimate") +
  theme_light()

ggplotly(ggpop)
```

# Tenure {data-orientation=rows}

## Row 1

### B25003: Tenure 

```{r}
ten <- acss %>% 
  filter(str_detect(variable, "B25003_00(2|3)")) %>% 
  mutate(variable = recode_factor(variable,
                                  "B25003_002" = "Owners",
                                  "B25003_003" = "Renters"))

ggTEN <- ten %>% 
  ggplot(aes(x = year, y = estimate, color = variable, fill = variable, group = 1)) +
  geom_ribbon(aes(ymax = estimate + moe, ymin = estimate - moe),
              alpha = 0.4) +
  geom_line() +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K"))+
  scale_x_continuous(breaks = unique(ten$year)) +
  labs(title = "Tenure of Households in Memphis, 2005-2019",
       y = "ACS estimate",
       x = "Year",
       fill = "Tenure",
       color = "",
       caption = "Shaded area represents margin of error around the ACS estimate") +
  theme_light()

ggplotly(ggTEN)
```

## Row 2

### B25008:  Total Population in Occupied Housing Units by Tenure 

```{r}
ten2 <- acss %>% 
  filter(str_detect(variable, "B25008_00(2|3)")) %>% 
  mutate(variable = recode_factor(variable,
                                  "B25008_002" = "Owners",
                                  "B25008_003" = "Renters"))

ggTEN2 <- ten2 %>% 
  ggplot(aes(x = year, y = estimate, color = variable, fill = variable, group = 1)) +
  geom_ribbon(aes(ymax = estimate + moe, ymin = estimate - moe),
              alpha = 0.4) +
  geom_line() +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K"))+
  scale_x_continuous(breaks = unique(ten2$year)) +
  labs(title = "Tenure of Population in Memphis, 2005-2019",
       y = "ACS estimate",
       x = "Year",
       fill = "Tenure",
       color = "",
       caption = "Shaded area represents margin of error around the ACS estimate") +
  theme_light()

ggplotly(ggTEN2)
```

# Cost Burden 

## B25106: Tenure by Housing Costs as a Percentage of Household Income {.tabset}

### Estimates

```{r}
v106 <- read_csv("../_data/vB25106.csv")
```

```{r}
thc <- acss %>%
  filter(str_starts(variable, "B25106")) %>%
  left_join(v106, by = c("year", "variable")) %>%
  separate(label,
           into = c("A", "B", "ten", "inc", "cb"),
           sep = "(:)?!!") %>%
  select(year, ten, inc, cb, estimate) %>%
  mutate(ten = str_remove_all(ten, "-occupied housing units(:)?"),
         inc = str_remove_all(inc, "(:|\\$)"),
         inc = fct_inorder(inc, ordered = TRUE)) %>%
  filter(!is.na(inc)) %>%
  mutate(
    cb = case_when(
      inc == "No cash rent" ~ "Affordable",
      inc == "Zero or negative income" ~ "Burden",
      cb == "Less than 20 percent" | cb == "20 to 29 percent" ~ "Affordable",
      cb == "30 percent or more" ~ "Burden"
    ),
    inc = str_replace_all(inc, "Zero or negative income", "Less than 20,000")
  ) %>% 
  filter(!is.na(cb)) %>% 
  group_by(year, ten, inc, cb) %>% 
  summarise(estimate = sum(estimate)) %>% 
  ungroup() %>% 
  mutate(inc = fct_relevel(inc, "Less than 20,000"))
```

```{r}
ggTHC <- thc %>%
  ggplot(aes(x = year, y = estimate, fill = cb)) +
  geom_col(position = "stack") +
  facet_grid(rows = vars(ten),
             cols = vars(inc),
             switch = "y") +
  scale_fill_manual(values = c("yellowgreen", "tomato")) +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K")) +
  labs(title = "Tenure by Income by Housing Cost Burden in Memphis, 2005-2019",
       y = "",
       x = "",
       fill = "Housing Costs") +
  theme_light()

ggplotly(ggTHC)
```

### Proportions

```{r}
ggTHC2 <- thc %>% 
  ggplot(aes(x = year, y = estimate, fill = cb)) +
    geom_col(position = "fill") +
    facet_grid(rows = vars(ten), cols = vars(inc), scales = "free") +
  scale_fill_manual(values = c("yellowgreen", "tomato")) +
  scale_y_continuous(labels = label_percent()) +
  labs(title = "Tenure by Income by Housing Cost Burden in Memphis, 2005-2019",
       y = "",
       x = "", 
       fill = "Housing Costs") +
  theme_light()

ggplotly(ggTHC2)
```


# Year over Year {data-orientation=rows}

```{r}
vYoY2 <- c(
  "B25119_001" = "Median Income",
  "B25119_002" = "Median Owner Income",
  "B25119_003" = "Median Renter Income",
  "B25058_001" = "Median Contract Rent",
  "B25064_001" = "Median Gross Rent",
  "B25071_001" = "Median Rent Burden"
)
```

```{r}
yoy2 <- acs3 %>% 
  filter(str_detect(variable, "B25(058|064|071|119)")) %>% 
  arrange(variable, year) %>% 
  group_by(variable) %>% 
  mutate(prev = lag(estimate), .after = estimate,
         diff = estimate - prev,
         diff = replace_na(diff, 0),
         variable = recode_factor(variable, !!!vYoY2)) 
```

## Row

### Income

```{r}
ggyoy2 <- yoy2 %>% 
  filter(str_detect(variable, "Income")) %>% 
  ggplot(aes(x = year, y = diff, color = variable)) +
  geom_line() +
  scale_x_continuous(breaks = unique(yoy2$year)) +
  theme_light()

ggplotly(ggyoy2)
```

## Row

### Rent

```{r}
ggyoy3 <- yoy2 %>% 
  filter(str_detect(variable, "Rent\\b")) %>% 
  ggplot(aes(x = year, y = diff, color = variable)) +
  geom_line() +
  scale_x_continuous(breaks = unique(yoy2$year)) +
  theme_light()

ggplotly(ggyoy3)
```

## Row {.sidebar}

```{r}
yoy2 %>% 
  summarise(sum = sum(diff)) %>% 
  datatable()
```


# Variables

## Col1

```{r}
vYoY <- c(
  "B25002_001" = "Housing Units",
  "B25002_002" = "Occupied Units",
  "B25002_003" = "Vacant Units",
  "B25008_001" = "Population",
  "B25008_002" = "Owners",
  "B25008_003" = "Renters"
)
```


```{r}
yoy <- acss %>% 
  filter(str_detect(variable, "B2500(2|8)")) %>% 
  arrange(variable, year) %>% 
  group_by(variable) %>% 
  mutate(prev = lag(estimate), .after = estimate,
         diff = estimate - prev,
         diff = replace_na(diff, 0),
         variable = recode_factor(variable, !!!vYoY)) 
```

### Variables

```{r}
ggyoy <- yoy %>% 
  ggplot(aes(x = year, y = diff, color = variable)) +
  geom_line() +
  scale_x_continuous(breaks = unique(yoy$year)) +
  theme_light()

ggplotly(ggyoy)
```

## dfs {data-width="220"}

### Change 

```{r}
yoy %>% 
  summarise(sum = sum(diff))
```

# Vacancy

## Col 2

### Vacancy Rate

```{r}
hsg <- acss %>% 
  filter(str_detect(variable, "B25002_003")) %>% 
  mutate(pct = (estimate / summary_est)*100)
```

```{r}
ggocc <- hsg %>% 
  ggplot(aes(x = year, y = pct)) +
  geom_line() +
  scale_x_continuous(breaks = unique(hsg$year)) +
  labs(title = "Vacancy Rate in Memphis, 2005-2019",
       y = "ACS estimate",
       x = "Year",
       caption = "Shaded area represents margin of error around the ACS estimate") +
  theme_light()

ggplotly(ggocc)
```

# Geo Mobility

## Tenure {.tabset}

```{r}
v713 <- read_csv("../_data/vB07013.csv")
v711 <- read_csv("../_data/vB07011.csv")
v712 <- read_csv("../_data/vB07012.csv")
```


```{r}
gmT <- acss %>% 
  filter(str_starts(variable, "B07013")) %>% 
  left_join(v713, by = c("year", "variable")) %>% 
  separate(label,
           into = c("A", "B", "loc", "tenure"),
           sep = "!!(:)?") %>% 
  select(-c(concept, A, B, summary_moe)) %>% 
  mutate(loc = str_remove_all(loc, ":"))
```

```{r}
gmT2 <- gmT %>% 
  select(year, loc, tenure, estimate) %>% 
  filter(!is.na(tenure)) %>% 
  group_by(year, loc) %>% 
  mutate(group_est = sum(estimate),
         loc = fct_inorder(loc),
         tenure = recode_factor(tenure, 
                                "Householder lived in owner-occupied housing units" = "Owner",
                                "Householder lived in renter-occupied housing units" = "Renter")) %>% 
  ungroup()
```

### Estimates

```{r}
ggGMT2 <- gmT2 %>% 
  ggplot(aes(x = year, y = estimate, fill = loc)) + 
  geom_col() +
  facet_wrap(~tenure) +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K"))

ggplotly(ggGMT2)
```

### Proportions

```{r}
ggGMT3 <- gmT2 %>% 
  ggplot(aes(x = year, y = estimate, fill = loc)) +
  geom_col(position = "fill") + 
  facet_wrap(~tenure) +
  scale_y_continuous(labels = label_percent())

ggplotly(ggGMT3)
```

### Median Income

```{r}
gmI <- acss %>% 
  filter(str_starts(variable, "B07011")) %>% 
  left_join(v711, by = c("year", "variable")) %>% 
  separate(label,
           into = c("A", "B", "C", "loc"),
           sep = "!!(:)?") %>% 
  select(-c(concept, A, B, C, summary_moe)) %>% 
  mutate(loc = str_remove_all(loc, ":"))
```

```{r}
gmI2 <- gmI %>% 
  select(year, loc, estimate) %>% 
  filter(!is.na(loc)) %>% 
  group_by(year, loc) %>% 
  mutate(loc = fct_inorder(loc)) %>% 
  ungroup()
```

```{r}
ggGMI2 <- gmI2 %>% 
  ggplot(aes(x = year, y = estimate, color = loc)) +
  geom_line() +
  scale_x_continuous(breaks = unique(gmI2$year)) +
  theme_light()

ggplotly(ggGMI2)
```

### Poverty Level Estimate

```{r}
gmPL <- acss %>% 
  filter(str_starts(variable, "B07012")) %>% 
  left_join(v712, by = c("year", "variable")) %>% 
  separate(label,
           into = c("A", "B", "loc", "pl"),
           sep = "!!(:)?") %>% 
  select(year, loc, pl, estimate) %>% 
  mutate(loc = str_remove_all(loc, ":")) %>% 
  filter(!is.na(pl)) %>% 
  group_by(year, loc) %>% 
  mutate(loc = fct_inorder(loc),
         pl = recode_factor(pl, 
                            "Below 100 percent of the poverty level" = "<100% PL",
                            "100 to 149 percent of the poverty level" = "100-149% PL",
                            "At or above 150 percent of the poverty level" = "150+% PL")) %>% 
  ungroup()
```


```{r}
ggGMPL <- gmPL %>% 
  ggplot(aes(x = year, y = estimate, fill = loc)) + 
  geom_col() +
  facet_wrap(~pl) +
  scale_y_continuous(labels = label_number(scale = .001, suffix = "K"))

ggplotly(ggGMPL)
```

### PL Proportions

```{r}
ggPL2 <- gmPL %>% 
  ggplot(aes(x = year, y = estimate, fill = loc)) +
  geom_col(position = "fill") + 
  facet_wrap(~pl) +
  scale_y_continuous(labels = label_percent())

ggplotly(ggPL2)
```
