
```{r}
library(tidyverse)
library(tidycensus)
```


```{r message=FALSE, warning=FALSE}
acs <- read_csv("../_data/acs.csv")
acss <- read_csv("../_data/acs_sum.csv")
v19 <- read_csv("../_data/v19acs1.csv")
yr <- read_csv("../_data/year.csv")
```

```{r}
vsum <- v19 %>% 
  filter(str_detect(name, "\\d_001"),
         !str_detect(concept, "ALLOCATION"))
```


```{r}
y05 <- 2005:2019
y20 <- 2009:2020
```

```{r}
vACS5 <- map_dfr(y20, ~ {
  load_variables(.x, dataset = "acs5")}, .id = "yr")
```

```{r}
vACS5 <- vACS5 %>% 
  mutate(yr = as.numeric(yr)) %>%
  left_join(yr) %>% 
  select(-yr) %>% 
  select(year, everything()) %>% 
  rename(variable = name)
```

```{r}
vACS1 <- vACS1 %>%
  filter(!str_detect(variable, "PR"))
```

```{r}
write_csv(vACS1, "../_data/vacs1.csv")
```

```{r}
v19w <- v19 %>% 
  separate(label, sep = "(\\:)?!!", into = c("v1", "v2", "v3", "v4", "v5", "v6", "v7", "v8"))
```

# Get variable names

```{r}
vACS1 <- read_csv("../_data/vacs1.csv")
```


```{r}
v106 <- vACS1 %>% 
  filter(str_starts(variable, "B25106")) 

write_csv(v106, "../_data/vB25106.csv")
```


# Summary

```{r}
ACS1 <- map_dfr(y05, ~ {
  get_acs(
    geography = "place",
    survey = "acs1",
    table = "B07013",
    summary_var = "	B07013_001",
    state = "TN",
    year = .x,
    cache_table = TRUE
  )
}, .id = "yr") %>% 
  filter(str_detect(NAME, "Memphis")) %>% 
  mutate(yr = as.numeric(yr))
```

# fixes error w/ summary variable
```{r}
ACS1 <- map_dfr(y05, ~ {
  get_acs(
    geography = "place",
    survey = "acs1",
    table = "B25106",
    state = "TN",
    year = .x,
    cache_table = TRUE
  )
}, .id = "yr") %>% 
  filter(str_detect(NAME, "Memphis")) %>% 
  mutate(yr = as.numeric(yr)) %>% 
  group_by(yr) %>% 
  mutate(summary_est = first(estimate),
         summary_moe = first(moe)) %>% 
  ungroup()
```

```{r}
ACS1 <- ACS1 %>%
  left_join(yr) %>% 
  select(-yr) %>% 
  select(year, everything())
```

```{r}
acss <- rbind(acss, ACS1)
write_csv(acss, "../_data/acs_sum.csv")
```

# Single Variable

```{r}
ACS2 <- map_dfr(y05, ~ {
  get_acs(
    geography = "place",
    survey = "acs1",
    variables = "B25077_001",
    state = "TN",
    year = .x,
    cache_table = TRUE
  )
}, .id = "yr") %>% 
  filter(str_detect(NAME, "Memphis")) %>% 
  mutate(yr = as.numeric(yr))
```

```{r}
ACS2 <- ACS2 %>%
  left_join(yr) %>% 
  select(-yr) %>% 
  select(year, everything()) %>% 
  mutate(dataset = "ACS1")
```

```{r}
acs <- rbind(acs, ACS2)
write_csv(acs, "../_data/acs.csv")
```
