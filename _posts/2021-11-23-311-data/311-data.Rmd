---
title: "311-data"
description: |
  A short description of the post.
author: ["Sarah Johnson"]
date: 2021-11-23
output:
  distill::distill_article:
    self_contained: false
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(tidyverse)
```

Download the dataset from [Memphis Data Hub](https://data.memphistn.gov/dataset/Service-Requests-since-2016/hmd4-ddta).

```{r}
Service_Requests_since_2016 <-
  read_csv(
    "Service_Requests_since_2016.csv",
    col_types = cols(
      ADDRESS2 = "c",
      ADDRESS3 = "c",
      COLLECTION_DAY = "c",
      CLOSE_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      CREATION_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      FOLLOWUP_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      INCIDENT_RESOLVED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      LAST_MODIFIED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      LAST_UPDATE_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      NEXT_OPEN_TASK_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      REPORTED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p")
    )
  )
```

As of November 9, 2021, the dataset contains 53 columns and 1,302,280 rows.

Filter for code enforcement data.

```{r}
CE <- Service_Requests_since_2016 %>%
  filter(DEPARTMENT == "Code Enforcement") %>%
  select(
    INCIDENT_NUMBER, #' service request (sr) number
    REQUEST_TYPE, #' request category
    CE_CATEGORY, #' category for CE action
    RESOLUTION_CODE:RESOLUTION_SUMMARY, #' how the request resolved
    REQUEST_STATUS, #' open or closed?
    PARCEL_ID, #' parcel ID
    ADDRESS1, #' the street name & number
    STREET_NAME,
    REPORTED_DATE, 
    LAST_MODIFIED_DATE, 
    OWNER_NAME, #' assigned code inspector
    CREATED_BY_USER,
    location1 #' geocoordinates
  ) %>% 
  mutate(RESOLUTION_SUMMARY = str_to_lower(RESOLUTION_SUMMARY),
         STREET_NAME = str_to_upper(STREET_NAME),
         REQUEST_TYPE = str_to_lower(REQUEST_TYPE)
         )
```

The output is 15 columns and 164,481 rows.

Currently, Code Enforcement does not have a category for cases related to occupied housing structures. These cases fall under "Substandard, Derelict Structures" or "Miscellaneous".

```{r}
vHsg <- c(
  "misc", "derelict"
  ) %>% 
  str_c(collapse = "|")

vNotHsg <- c(
  "VOYC", "VOAR", "CVOAR", "CVOAT", "CVOYC", "SHELBY", "COMMERCIAL", "STCLEANING",
  "shelb(y|h)[\\s]{0,2}(c|cc)", "please contact mlgw", "mow", "commer[ci]*al"
) %>% 
  str_c(collapse = "|")

notHsg <- CE %>% 
  filter(str_detect(RESOLUTION_CODE, vNotHsg) |
         str_detect(RESOLUTION_SUMMARY, vNotHsg))
  
hsg <- CE %>% 
  anti_join(notHsg, by = "INCIDENT_NUMBER") %>% 
  filter(str_detect(REQUEST_TYPE, vHsg)) %>% 
  mutate(REQUEST_TYPE = 
           str_replace_all(
             REQUEST_TYPE, c("ce-substandard,derelict struc" = "derelict",
                             "ce-code miscellaneous" = "misc")),
         RESOLUTION_SUMMARY = trimws(RESOLUTION_SUMMARY))
  
hsg %>% count(REQUEST_TYPE) %>% arrange(desc(n))

hsg <- hsg %>% select(-REQUEST_TYPE)
```

<!--# end hsg CE -->

```{r}
tenant0 <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\b(tob)?t[aent]*t(s|ed)?\\b|tenate"))

vTenant <- c(
  "\\b(tob)?t[aent]*t(s|ed)?",
  "resident(s)?",
  "tensnt(s)?",
  "o[cu]+pant(s)?",
  "tenate\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

tenant1 <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vTenant))

tenant10 <- tenant1 %>% 
  anti_join(tenant0, by = "INCIDENT_NUMBER")
```

```{r}
moved0 <- tenant0 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\bmoved|\\bmoving"))
moved1 <- tenant1 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\bmoved|\\bmoving"))
moved2 <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\bmoved|\\bmoving"))

movedNoTen1 <- moved2 %>% 
  anti_join(tenant1, by = "INCIDENT_NUMBER")
```

```{r}
mold <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\bmold"))

moldNoTen1 <- mold %>% 
  anti_join(tenant1, by = "INCIDENT_NUMBER")
```

```{r}
vApt <- c(
  "\\bapartment",
  "apt",
  "unit\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

apt <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vApt))

aptNoTen1 <- apt %>% 
  anti_join(tenant1, by = "INCIDENT_NUMBER")
```

```{r}
vFurnish <- c(
  "\\btoilet",
  "tub",
  "fridge",
  "refrigerator",
  "ceiling",
  "sink",
  "cabinets",
  "heating",
  "living( )?room",
  "carpet",
  "bed bug",
  "kitchen",
  "hallway",
  "stove\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

furnish <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vFurnish))

furnishtNoTen1 <- furnish %>% 
  anti_join(tenant1, by = "INCIDENT_NUMBER")
furnishNoApt <- furnish %>% 
  anti_join(apt, by = "INCIDENT_NUMBER")
```

<!--# remove symbols -->

```{r}
# clean-up resolution summary
hsg2 <- hsg %>% 
  mutate(RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, "[:punct:]|[:symbol:]"))
```

## Inspectors

```{r}
inspect0 <- hsg2 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "per inspector"))

vInspectors <- c(
  "[e]?[ ]?blow",
  "[k]?[ ]?boone",
  "[c]?[ ]?boykins",
  "[b]?[ ]?bratten",
  "[r]?[ ]?brown",
  "[c]?[ ]?bryant",
  "[s]?[ ]?burgess",
  "[d]?[ ]?burton",
  "[l]?[ ]?busby",
  "[dr]?[ ]?butler",
  "ch[am]+?bers",
  "(c|cheryl)?[ ]?clausel",
  "[t]?[ ]?cobb",
  "[a]?[ ]?collins",
  "[j]?[ ]?cooper",
  "[e]?[ ]?cooper",
  "[al]?[ ]?davis",
  "[s]?[ ]?echols",
  "[v]?[ ]?ervin",
  "ferguson",
  "[t]?[ ]?fry",
  "funches",
  "[s]?[ ]?gaspar",
  "(q|quatarious)?[ ]?gilc[l]?hrest",
  "[j]?[ ]?golden",
  "[d]?[ ]?grafton",
  "(r|robert)?[ ]?gray",
  "griffin",
  "[ar]?( )*hill",
  "[c]?[ ]?higgenbottom",
  "[s]?[ ]?howell",
  "[j]?[ ]?hymon",
  "[j]?[a]?[ ]?irwin",
  "[j]?[ ]?jackson",
  "[m]?[ ]?james",
  "johnson",
  "[c]?[ ]?jones",
  "judy",
  "[r]?[ ]?lake",
  "[amw]?[ ]?lewis", 
  "lynum",
  "[d]?[ ]?massey",
  "[m]?[ ]?middlebrooks",
  "[s]?[ ]?milan",
  "[d]?[ ]?mi[t]?chell",
  "[j]?[ ]mos[lbe]+?y",
  "[v]?[ ]?moses",
  "[t]?[ ]?neff",
  "[r]?[ ]?nelson",
  "(j|judith)?[ ]?norman",
  "[t]?[ ]?norwood",
  "[b]?[ ]?pat[t]?erson", 
  "[k]?[ ]?payne",
  "[r]?[ ]?peete(e)?",
  "[t]?[ ]?pegues",
  "[a]?[ ]?powell",
  "[m]?[ ]?pruitt",
  "[rn]?[ ]?rashada",
  "[s]?[ ]?rice",
  "[t]?[ ]?richardson",
  "rimmer",
  "[c]?[ ]?sager",
  "[r]?[ ]?sherrell",
  "[b]?[ ]?smith",
  "[t]?[ ]?strong",
  "[m]?[ ]?tay[h]?lor",
  "[c]?[ ]?thom[a]?s",
  "[j]?[ ]?tumbrink",
  "[p]?[ ]?tyler",
  "tyrone",
  "waler",
  "[j]?[ ]?walker",
  "[m]?[ ]?ward",
  "[k]?[ ]?washington",
  "[a]?[ ]{0,2}?wi[l]+?[i]?am[s]?",
  "[c]?[ ]?wi[l]+?[i]?ams",
  "[rd]?[ ]?witter",
  "[b]?[ ]?woodland",
  "[v]?[ ]?woods"
) %>% 
  str_c(collapse = "|")

inspect <- inspect0 %>% 
  mutate(RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, "per inspector[s]?"),
         pName = str_extract_all(RESOLUTION_SUMMARY, vInspectors),
         pRole = "inspector",
         RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, vInspectors),
         pName = trimws(pName),
         RESOLUTION_SUMMARY = trimws(RESOLUTION_SUMMARY)
         ) %>% 
  select(pRole, pName, RESOLUTION_SUMMARY, everything())
```

## Numbers

### Separate

```{r}
rmNum <- inspect %>% 
  mutate(number = str_extract_all(RESOLUTION_SUMMARY, "[:digit:]+"),
         RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, "[:digit:]+"),
         RESOLUTION_SUMMARY = trimws(RESOLUTION_SUMMARY)) %>% 
  select(RESOLUTION_SUMMARY, everything()) %>% 
  arrange(desc(RESOLUTION_SUMMARY))
```

### Service Requests

```{r}
srno <- regex("(\\d{7})")
sr1 <- regex("\\d{7}[2606482-5495084]")
sr2 <- regex("(\\d{2606482,5495084})")
vDate <- regex("{112016,20211225}")
```

```{r}
sr <- inspect %>% 
  filter(str_detect(RESOLUTION_SUMMARY, srno)) %>% 
  mutate(sr = str_extract_all(RESOLUTION_SUMMARY, srno)) %>% 
  select(sr, everything()) 
```

<!--# no new info in RS -->

```{r}
vExtra <- c(
  "\\ba",
  "an",
  "and",
  "are",
  "as",
  "at",
  "been",
  "but",
  "for",
  "from",
  "has",
  "have",
  "in",
  "is",
  "nd",
  "now",
  "please",
  "rd",
  "see",
  "sr",
  "the",
  "there",
  "this",
  "time of (re)?in[sp]*ection",
  "to",
  "on",
  "was",
  "were",
  "who",
  "will",
  "with\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

hsg3 <- rmNum %>% 
  mutate(RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, vExtra),
         RESOLUTION_SUMMARY = trimws(RESOLUTION_SUMMARY)) %>% 
  arrange(desc(RESOLUTION_SUMMARY))
```

```{r}
vRes <- c(
  "\\b(bs|c[dor]|cdo|cvoid|cvoar|fu|j[aer]|jwrh|ma|nj|noh|s r|uc|vo)\\b",
  "act[io]ve",
  "(made)?( )*a[t]*em[op][t]?(s)?",
  "board(ed)?",
  "close(d)?( )*(void|other)?",
  "civil (matter|issue)",
  "demolished( by)?( )*(owner)?",
  "(left)?( )*(door)?( )*(tag|hanger)",
  "(in)?compl[ia]*nce",
  "justified active",
  "no one home",
  "(no )?f[io]llow up( date)?( given)?",
  "no (answer|contact|response)( )*(tenant)?",
  "not justified",
  "occupied",
  "file( )*(folder)?",
  "\\bold( )*(data|file)?",
  "hearing rescheduled",
  "h(o)?use|home|lot|property|unit(s)?",
  "insufficient( )*(address|information)?",
  "issued",
  "reboard(ed)?",
  "rebuilt",
  "recheck",
  "recreated",
  "refer",
  "r[ae]hab(be[ds])?",
  "re( )*is[su]ue(d)?",
  "repair(ed)?(s)?( )*(completed|made)?",
  "secure(d)?",
  "(sold )?new owner",
  "unative",
  "vacant",
  "((n)?o(t)?)?( )*(housing)?( )*(code)?( )*v( )*io(i)?(l)?a(l)?tio(n)?(s)?( )*((m)?(f)?oun[df])?",
  "(c)?vo[bm](r)?",
  "vo[nw]p",
  "(c)?voyc",
  "(wp[op]|work progress)",
  "write( )*up",
  "(incorrect|wrong) address"
) %>% 
  str_c(collapse = "|")

fix <- hsg3 %>% 
  mutate(RES_CODE = str_extract_all(RESOLUTION_SUMMARY, vRes),
         RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, vRes),
         RESOLUTION_SUMMARY = trimws(RESOLUTION_SUMMARY)) %>% 
  select(RES_CODE, everything()) %>% 
  arrange(desc(RESOLUTION_SUMMARY))
```

```{r}
vRes <- c(
  "at (the)?( )*time of inspection",
  "cdo",
  "close(d)?( )*(demolished|out|rehab(bed)?|violation|void|other)?",
  "\\b(co|cr|ma)\\b",
  "cvoid",
  "(no)?( )*(\\bfu\\b|f[io]llow up)( )*(date)?( )*(given)?",
  "hearing rescheduled",
  "in( )*compl[ia]*nce",
  "insufficient( )*(address|information)?",
  "ja|justified active",
  "jwrh",
  "(\\bma\\b|made( )*attempt(s)?)",
  "(nd|rd) (attem[op](t)?|visit)",
  "(noh|no one home)",
  "no (answer|call back|contact|response)",
  "(not justified|nj)",
  "old (data|file|sr)",
  "(house|property) (has been|is)?( )*(now)*( )*(boarded( up?)|demo(d|lished)|occupied|r[ae]hab(bed)?|secure(d)?|vacant)?( )*(by)*( )*(the)*( )*(owner)*",
  "recheck",
  "recreated",
  "rebuilt",
  "reboard(ed)?",
  "rehabbe[ds]",
  "reissue(d)?( )*(to owner|for proper grading)?",
  "repairs (have been|were)?( )*(made|completed)",
  "sold new owner",
  "(please )?(refer to|see) (file|sr)*( )*(folder)?",
  "(see|sr)",
  "uc",
  "unative",
  "vacant( )*(lot|property|unit)?",
  "no( )*v( )*io(i)?(l)?a(l)?tio(n)?(s)?( )*((m)?(f)?oun[df])?",
  "will reis[su]ue(d)?( )?(vo|violation)?",
  "(c)?vo[abm](r)?( )*(fu|issued)?",
  "vo[nw]p",
  "(c)?voyc( )*",
  "wpp",
  "(incorrect|wrong) address"
) %>% 
  str_c(collapse = "|")

fix <- rmNum %>% 
  mutate(RES_CODE = str_extract_all(RESOLUTION_SUMMARY, vRes),
         RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, vRes),
         RESOLUTION_SUMMARY = trimws(RESOLUTION_SUMMARY),
         RESOLUTION_SUMMARY = str_remove_all(RESOLUTION_SUMMARY, "^on$")) %>% 
  select(RES_CODE, everything()) %>% 
  arrange(desc(RESOLUTION_SUMMARY))
```

```{r}
vFix <- c(
  "^at the time of inspection the violation has been corrected", 
  "at the time of inspection all code violations have been corrected\\.",
  "violation has been corrected", "violation has been corrected  \\.", "corrected",
  "resolved", "issue resolved", "issues resolved", "violation resloved",
  "violations resolve at time of inspection", "voilation resloved",
  "rehabbed", "property rehabbed", 
  "property rehabbed- pictures provided", "property rehabbed- pictures provided- ma",
  "rehabbed per inspector b. patterson", "rehabbed per inspector n. rashada",
  "repairs made", "repaired", "repairs have been made", 
  "repairs were made", "repairs made at time of inspection",
  "repairs made in compliance", "not justified repairs already made",
  "in compliance", "incompliance", "in complaince", "in  compliance",
  "in compliance with court order", "in compliance w/ co", "in compliance \\(court order\\)",
  "in compliance at the time of inspection", 
  "in compliance at time of inspection",
  "closed violation in compliance at time of inspection",
  "closed violation property in compliance at time of inspection",
  "at time of inspection property was in compliance", 
  "at time of inspection, property was in compliance", 
  "at the time of inspection property was in compliance\\.",
  "incompliance at the time of recheck", "in compliance at the time of recheck",
  "in compliance at time of recheck", "in compliance recheck",
  "in compliance repairs have been made",
  "in compliance at the time of inspection sburgess",
  "closed violation property in compliance at time of inspection per inspector j cooper",
  "at time of inspection, property came into compliance\\.",
  "incomplaince at the time of recheck$"
) %>% 
  str_c(collapse = "$|^")

fix <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vFix))
notFix2 <- hsg %>% 
  anti_join(fix, by = "INCIDENT_NUMBER")

noInfo <- c(
  "^close board and secure", "sent to cd to board and secure", #CB-S
  "issued a notice to board and secure property from casual entry\\.",
  "boarded by owner", #CB-SO
  "demolished by condemnation", #CDC
  "closed, demolished by owner", "property demolished by the owner", #CDO
  "demolished by the owner",
  "closed, other", #CO
  "closed, rehab", "rehabilitation by the owner", #CR
  "rehabilitation by the owner\\.", #CR
  "cr per inspector r. witter", "cr per inspector r. hill", "cr per inspector b. patterson",
  "comp\\. v\\.o\\. bldg\\. demolished", #CVOBD
  "comp\\. v\\.o\\. bldg\\. repaired", #CVOBR
  "closed void", "cvoid", #CVOID
  "comp\\. v\\.o\\. - miscellaneous", "cvom", #CVOM
  "cvom per inspector s. howell- ma", "cvom per inspector m. james", 
  "cvom per inspector r. gray- ma", "cvom per inspector d. grafton",
  "cvom per inspector j. walker", "closed per sup jackson",
  "dismissed", "case dismissed", #DISM
  "case not justified", "not justified", "not justified at the time of inspection", #NJ
  "not justified at time of inspection", "not justified per inspection", "nj",
  "complaint not justified", "no violation at time of inspection",
  "nj no violations at the time of inspection sh",
  "not justified, no violation at the time of the inspection",
  "no violation at the time of the inspection  \\.",
  "no violation at the time of the inspection\\.",
  "no violation at the time of this inspection\\.",
  "no violations at time of inspection rdw",
  "at the time of inspection there were no violations",
  "there was no violation at the time of inspection", "not a code violation",
  "no code violations observed at time of inspection",
  "no violation at the time of inspection\\.", 
  "no violation present at time of inspection",
  "at the time of inspection there were no violation", "no violations at time of inspection",
  "no violation at time of inspection per inspector burton",
  "not justified per t.strong", "not justified at time of inspection per inspector j cooper",
  "not justified per inspector j cooper",
  "active npa case", "npa-active", #NPA-ACTIVE
  "insufficient information", "wrong address", "no such address", #INSUF
  "justified, active already file", "justified active", "ja", #JA
  "jw-dm", "jwdm", #JW-DM
  "jw-rh", #JW-RH
  "shelby county property", #SHELBY
  "please contact shelby county 901-222-2300 for additional assistance\\.",
  "please contact shelby county 901-222-2300 for additional assistance",
  "uncooperative", "uncopperative", "un cooperative", #UC
  "uncooperative per inspector j cooper",
  "per inspector", "per inspector james", "per inspector burton", "per inspector walker", 
  "per inspector rice", "per inspector boykins", "per inspector pegues",
  "per inspector ward", "per inspector clausel", "per inspector butler",
  "per inspector cooper", "per inspector blow", "per james jackson", "per inspector fry",
  "per inspector d.burton",
  "�����", "���$"
) %>% 
  str_c(collapse = "$|^")

noRS <- notFix2 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, noInfo) |
         is.na(RESOLUTION_SUMMARY))

SR <- notFix2 %>% 
  anti_join(noRS, by = "INCIDENT_NUMBER") %>% 
  select(RESOLUTION_CODE, RESOLUTION_SUMMARY, everything())
SR2 <- SR %>% count(RESOLUTION_SUMMARY) %>% arrange(desc(n))
```

<!--# status report -->

```{r}
vClosed <- c("Closed", "Resolved") %>% str_c(collapse = "|")

closed <- hsg %>% 
  filter(str_detect(REQUEST_STATUS, vClosed))
open <- hsg %>% 
  filter(!str_detect(REQUEST_STATUS, vClosed))

open %>% count(CE_CATEGORY) %>% arrange(desc(n))
open %>% count(RESOLUTION_CODE) %>% arrange(desc(n))
```

```{r}
viol <- hsg %>% 
  filter(str_detect(CE_CATEGORY, "VIOLATION"))
cViol <- viol %>% group_by(CE_CATEGORY, RESOLUTION_CODE) %>% count(RESOLUTION_CODE) %>% arrange(desc(n))
```

<!--# status -->

Clean up the address column. I'm standardizing it to "STNO STNAME", removing any suffixes, prefixes, or apartment numbers.

```{r}
streets <- 
  c(" AVE", "AV", "ALLEY", "RD", "DR", "ST", 
    "SQUARE", "PL", "BLD", "BLVD", "CIR", "CT", 
    "PKY", "PKWY", "APT", "LN", "STE", "COVE$"
    ) %>% 
  str_c(collapse = "$| ")
ststart <- 
  c("^N", "S", "E", "W ") %>% 
  str_c(collapse = " |^")
stend <- c(" E", "A", "N", "S$") %>% 
  str_c(collapse = "$| ")
```

```{r}
hsg2 <- hsg %>% 
  filter(!str_detect(ADDRESS1, "-|/|\\(|\\.\\s\\d")) %>% 
  mutate(STREET_NAME = str_replace_all(STREET_NAME, "[[:punct:]]", " ")) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, "[:digit:]+")) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, "[:blank:]$")) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, streets)) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, "[:blank:]$")) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, streets)) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, ststart)) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, stend)) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, streets)) %>% 
  mutate(STREET_NAME = str_remove(STREET_NAME, "^[:blank:]+")) %>% 
  mutate(STREET_NAME = str_replace_all(STREET_NAME, "SAINT", "ST")) %>% 
  mutate(STREET_NAME = str_replace_all(STREET_NAME, "BENBOW", "BEN BOW")) %>% 
  mutate(STNO = str_extract_all(ADDRESS1, "^[:digit:]+")) %>% 
  unite(STREET, STNO, STREET_NAME, sep = " ", remove = FALSE) %>% 
  filter(STNO != 0) %>% 
  filter(str_detect(STREET, "[:alpha:]")) %>% 
  select(INCIDENT_NUMBER, STREET, RESOLUTION_CODE:RESOLUTION_SUMMARY, everything())
```

I filtered out invalid street addresses, those with an invalid street address for housing, and incidents that span multiple properties (probably already messed up, there's some legitimate cases). This leaves 161,848 observations.

```{r}
CE3 <- CE2 %>% 
  
  filter(!is.na(RESOLUTION_SUMMARY)) %>% 
  filter(RESOLUTION_SUMMARY == "���")
```

<!--# check your work -->

```{r}
EC <- CE %>% 
  anti_join(CE2, by = "INCIDENT_NUMBER")
```

```{r}
cnt <- CE2 %>% count(STREET) %>% arrange(desc(n))
```

```{r}
CE2 %>% count(INCIDENT_NUMBER) #164,481 now 161,848
CE2 %>% count(PARCEL_ID) %>% arrange(desc(n)) #67,715 now 66,640
CE2 %>% count(ADDRESS1) %>% arrange(desc(n)) #76,745 now 75,611
CE2 %>% count(STREET_NAME) %>% arrange(desc(n)) # new 6,016
CE2 %>% count(STREET) %>% arrange(desc(n)) # new 73,429
CE2 %>% count(REQUEST_TYPE) %>% arrange(desc(n)) #14 same
CE2 %>% count(CE_CATEGORY) %>% arrange(desc(n)) #10 same
CE2 %>% count(RESOLUTION_CODE) %>% arrange(desc(n)) #89 now 87
CE2 %>% count(RESOLUTION_CODE_MEANING) %>% arrange(desc(n)) #86 now 84
CE2 %>% count(RESOLUTION_SUMMARY) %>% arrange(desc(n)) #47,328 now 46,443
CE2 %>% count(REQUEST_STATUS) %>% arrange(desc(n)) #6 same
CE2 %>% count(REPORTED_DATE) %>% arrange(desc(n)) #162,466 now 159,893
CE2 %>% count(LAST_MODIFIED_DATE) %>% arrange(desc(n)) #60,227 now 59,121
CE2 %>% count(OWNER_NAME) %>% arrange(desc(n)) #43 now 42
CE2 %>% count(CREATED_BY_USER) %>% arrange(desc(n)) #326 now 191
CE2 %>% count(location1) %>% arrange(desc(n)) #19,491 now 19,472
```

<!--# next up -->

```{r}
phone <- regex("\\(?(\\d{3})[) -]?(\\d{3})[ -]?(\\d{4})")
sr <- regex("(\\d{7})")
da <- regex("(\\d{1,2})[/ -\\.]?(\\d{1,2})[/ -\\.]?(\\d{2,4})[/ -\\.]?") 
fine <- regex("[:digit:][:blank:]?fine")
```

```{r}
datesfsf <- 
  inspect %>% filter(str_detect(RESOLUTION_SUMMARY, da))
```

```{r}
CE3 <- CE2 %>% 
  filter(!is.na(RESOLUTION_SUMMARY)) %>% 
  filter(!str_detect(RESOLUTION_SUMMARY, phone)) %>% 
  filter(!str_detect(RESOLUTION_SUMMARY, sr)) %>% 
  filter(!str_detect(RESOLUTION_SUMMARY, "tax sale")) %>% 
  filter(!str_detect(RESOLUTION_SUMMARY, fine))
```

```{r}
srtest <- CE3 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, sr)) %>% 
  mutate(srAlt = str_extract_all(RESOLUTION_SUMMARY, sr)) %>% 
  select(srAlt, RESOLUTION_SUMMARY, everything())
```

```{r}
datetest <- CE3 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, da)) %>% 
  mutate(updated = str_extract(RESOLUTION_SUMMARY, da)) %>% 
  select(updated, RESOLUTION_SUMMARY, everything())
```

```{r}
tx <- CE3 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "tax sale"))
```

test

<!--# end next up -->

## Doxxing Problem

If inspectors need to contact someone, they will often put their name and phone number in the `RESOLUTION_SUMMARY`.

Use this code to find any phone numbers:

```{r}
phone <- regex("
  \\(?     # optional opening parens
  (\\d{3}) # area code
  [) -]?   # optional closing parens, space, or dash
  (\\d{3}) # another three numbers
  [ -]?    # optional space or dash
  (\\d{4}) # three more numbers
  ", comments = TRUE
)
```

Below is a list of public/commercial numbers that have been mentioned in the dataset, excluding property management companies.

```{r}
vPh <- c(
  "222[-]?2300", #Shelby County code
  "222[-]?2575", #Shelby County land bank
  "222[-]?7000", #property assessor
  "222[-]?8392", #Shelby County code
  "222[-]?8394", #Shelby County code
  "222[-]?8396", #Shelby County code
  "222[-]?8300", #Shelby County code
  "222[-]?9000", #health dept
  "222[-]?9715", #vector control
  "222[-]?9725", #vector control
  "357[-]?3330", #B&C towing
  "388[-]?0642", #Summer Wrecker (towing)
  "416[-]?5300", #Shelby County schools
  "452[-]?4101", #B&B towing
  "500[-]?6139", #inspector 
  "500[-]?8903", #inspector boone
  "509[-]?3789", #overton park conservancy
  "521[-]?4804", #US Coast Guard
  "544[-]?6549", #MLGW
  "545[-]?2677", #non-emergency MPD
  "553[-]?6900", #PB&J towing
  "568[-]?7658", #inspector
  "576[-]?7464", #city code office
  "598[-]?8555", #apex wildlife
  "633[-]?6500", #311
  "636[-]?1416", #memphis animal services
  "636[-]?2110", #inspector sager
  "636[-]?2122", #inspector
  "636[-]?6500", #MCSC
  "636[-]?6614", #public records
  "636[-]?6616", #city claims
  "636[-]?7435", #shelby county
  "636[-]?7448", #demolition
  "636[-]?7464", #city condemnation
  "684[-]?5467", #tdot
  "721[-]?1517", #MLGW
  "794[-]?1200", #westbrook towing
  "820[-]?7878" #MLGW
) %>% 
  str_c(collapse = "|")
```

Below is a list of all the people doxxed in the dataset.

```{r warning=FALSE}
phst <- CE2 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, phone)) %>% 
  mutate(ph = str_extract_all(RESOLUTION_SUMMARY, phone)) %>% 
  select(ph, RESOLUTION_SUMMARY, everything()) %>% 
  filter(!str_detect(ph, phc)) %>% 
  filter(!str_detect(ph, "^0")) # a couple parcel numbers slipped through
phst2 <- phst %>% count(ph) %>% arrange(desc(n))
```

There are 426 phone numbers listed, 405 of which are unique. Nearly all of the remaining phone numbers belong to tenants, property managers, or owners.

```{r eval=FALSE, include=FALSE}
#' double check to see phone numbers that were filtered out
ph <- CE2 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, phone)) %>% 
  mutate(ph = str_extract_all(RESOLUTION_SUMMARY, phone))
phdel <- ph %>% anti_join(phst, by = "INCIDENT_NUMBER")
```

<!--# end doxxing section -->

```{r}
#5268622 trees aren't covered by code??
```

<!--# imported -->

What information can we gather by finding the number of unique rows in each column?

    INCIDENT_NUMBER = unique key

    location1 19491
    PARCEL_ID 67715
    ADDRESS1 76745
    All location variables have different # of unique rows, meaning we're going to run into problems trying to map the data.

    REQUEST_STATUS 6
    CE_CATEGORY 10
    REQUEST_TYPE 14
    RESOLUTION_CODE_MEANING 86
    RESOLUTION_CODE 89
    RESOLUTION_SUMMARY 47328

    LAST_MODIFIED_DATE 60227 Possibly unreliable
    REPORTED_DATE 162466

    OWNER_NAME 43
    CREATED_BY_USER 326

Sort by `REPORTED_DATE`.

```{r reportedDate}
y2016 <- CE %>% filter(REPORTED_DATE < "2017-01-01")
y2017 <- CE %>% filter(REPORTED_DATE >= "2017-01-01", REPORTED_DATE < "2018-01-01")
y2018 <- CE %>% filter(REPORTED_DATE >= "2018-01-01", REPORTED_DATE < "2019-01-01")
y2019 <- CE %>% filter(REPORTED_DATE >= "2019-01-01", REPORTED_DATE < "2020-01-01")
y2020 <- CE %>% filter(REPORTED_DATE >= "2020-01-01", REPORTED_DATE < "2021-01-01")
y2021 <- CE %>% filter(REPORTED_DATE >= "2021-01-01")
```

Active Cases

```{r}
vClosed <- c("Closed", "Resolved") %>% str_c(collapse = "|")
```

```{r}
o2016 <- y2016 %>% filter(!str_detect(REQUEST_STATUS, closed))
o2017 <- y2017 %>% filter(!str_detect(REQUEST_STATUS, closed))
o2018 <- y2018 %>% filter(!str_detect(REQUEST_STATUS, closed))
o2019 <- y2019 %>% filter(!str_detect(REQUEST_STATUS, closed))
o2020 <- y2020 %>% filter(!str_detect(REQUEST_STATUS, closed))
o2021 <- y2021 %>% filter(!str_detect(REQUEST_STATUS, closed))
```

Request Type

```{r}
yr2016 %>% 
  count(REQUEST_TYPE) %>% 
  mutate(total = sum(n),
         pct = n / total) %>% 
  slice_max(n, n = 5)
yr2017 %>% 
  count(REQUEST_TYPE) %>% 
  mutate(total = sum(n),
         pct = n / total) %>% 
  slice_max(n, n = 5)
yr2018 %>% 
  count(REQUEST_TYPE) %>% 
  mutate(total = sum(n),
         pct = n / total) %>% 
  slice_max(n, n = 5)
yr2019 %>% 
  count(REQUEST_TYPE) %>% 
  mutate(total = sum(n),
         pct = n / total) %>% 
  slice_max(n, n = 5)
yr2020 %>% 
  count(REQUEST_TYPE) %>% 
  mutate(total = sum(n),
         pct = n / total) %>% 
  slice_max(n, n = 5)
yr2021 %>% 
  count(REQUEST_TYPE) %>% 
  mutate(total = sum(n),
         pct = n / total) %>% 
  slice_max(n, n = 5)
```
