---
title: "CE3: Finding and fixing duplicates"
description: |
  How to identify and fix related service requests.
author:
  - name: Sarah Johnson
date: 2021-12-07
categories:
  - code enforcement
output:
  distill::distill_article:
    self_contained: false
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  R.options = list(width = 70))
```

## Intro

### Example

Below are five unique service requests, four of which redirect users to a different service request. However, if we were to only refer to the "final" service request, we would not know that there was once a tenant who vacated the property.

+---+-----------------+-----------------------------------------------------------+
|   | Service Request | Resolution Summary                                        |
+===+=================+===========================================================+
| 1 | 4452866         | closed void tenant vacated property written up sr 4482990 |
+---+-----------------+-----------------------------------------------------------+
| 2 | 4455128         | closed void tenant vacated property written up sr 4482990 |
+---+-----------------+-----------------------------------------------------------+
| 3 | 4482990         | see sr 3734488                                            |
+---+-----------------+-----------------------------------------------------------+
| 4 | 3734488         | see sr 5057460                                            |
+---+-----------------+-----------------------------------------------------------+
| 5 | 5057460         | closed violation in compliance                            |
+---+-----------------+-----------------------------------------------------------+

: Example of the duplicate problem

The goal is to transform all of the resolution summaries to show the same information.

## Getting Started

```{r}
library(tidyverse)
```

Full table

```{r}
Service_Requests_since_2016 <-
  read_csv(
    "../_data/Service_Requests_since_2016.csv",
    col_types = cols(
      ADDRESS2 = "c",
      ADDRESS3 = "c",
      COLLECTION_DAY = "c",
      CLOSE_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      CREATION_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      FOLLOWUP_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      INCIDENT_RESOLVED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      LAST_MODIFIED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      LAST_UPDATE_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      NEXT_OPEN_TASK_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      REPORTED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p")
    )
  ) %>% 
  mutate(RESOLUTION_SUMMARY = str_to_lower(RESOLUTION_SUMMARY),
         STREET_NAME = str_to_upper(STREET_NAME),
         REQUEST_TYPE = str_to_lower(REQUEST_TYPE)
         )
```

CE

```{r}
CE <- Service_Requests_since_2016 %>% 
  filter(DEPARTMENT == "Code Enforcement") %>%
  select(
    INCIDENT_NUMBER,
    GROUP_NAME,
    REQUEST_TYPE,
    CE_CATEGORY,
    RESOLUTION_CODE:RESOLUTION_SUMMARY,
    REQUEST_STATUS,
    ADDRESS1,
    STREET_NAME,
    PARCEL_ID,
    REPORTED_DATE,
    FOLLOWUP_DATE,
    LAST_MODIFIED_DATE,
    CLOSE_DATE,
    OWNER_NAME,
    CREATED_BY_USER,
    REQUEST_PRIORITY,
    location1
  ) 
```

Housing

```{r}
vHsg <- c("misc", "derelict") %>% str_c(collapse = "|")

vNotHsg <- c(
  "VOYC", "VOAR", "CVOAR", "CVOAT", "CVOYC", "COMMERCIAL", "STCLEANING",
  "mow", "commer[ci]*al", "vacant lot"
  ) %>% 
  str_c(collapse = "|")

notHsg <- CE %>%
  filter(
    str_detect(RESOLUTION_CODE, vNotHsg) |
      str_detect(RESOLUTION_SUMMARY, vNotHsg) |
      !str_detect(REQUEST_TYPE, vHsg)
  )

hsg <- CE %>% 
  anti_join(notHsg, by = "INCIDENT_NUMBER")
```

Duplicates

```{r}
dup <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  select(INCIDENT_NUMBER, RESOLUTION_SUMMARY) %>% 
  mutate(srRelated = str_extract_all(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  unnest_longer(srRelated) %>% 
  mutate(srRelated = str_remove_all(srRelated, "[^[:digit:]]"),
         srRelated = as.numeric(srRelated)) %>% 
  distinct()
```

Inner join with original imported data.

```{r}
dup2 <- dup %>% 
  filter(INCIDENT_NUMBER != srRelated) %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated, RESOLUTION_SUMMARY.y)
```

4090

```{r}
err <- dup %>% 
  filter(str_detect(srRelated, "\\d{8}")) %>% 
  mutate(RES_SUM = "too many digits")

dupdup <- dup %>% 
  filter(INCIDENT_NUMBER == srRelated) %>% 
  mutate(RES_SUM = "recursive")

mis <- dup %>% 
  anti_join(dup2, by = "INCIDENT_NUMBER") %>% 
  anti_join(err, by = "INCIDENT_NUMBER") %>% 
  anti_join(dupdup, by = "INCIDENT_NUMBER") %>% 
  mutate(RES_SUM = "not found")

dup3 <- dup2 %>% 
  filter(str_detect(RESOLUTION_SUMMARY.y, "\\b[sr #]*\\d{7,8}\\b"))

dup2 <- dup2 %>% 
  anti_join(dup3) 
```

380 mention another SR in the referenced SR (dup3).

```{r}
dup3 <- dup3 %>% 
  mutate(srRelated2 = str_extract_all(RESOLUTION_SUMMARY.y, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  unnest_longer(srRelated2) %>% 
  mutate(srRelated2 = str_remove_all(srRelated2, "[^[:digit:]]"),
         srRelated2 = as.numeric(srRelated2)) %>% 
  distinct()

dup4 <- dup3 %>% 
  filter(INCIDENT_NUMBER != srRelated2) %>% 
  filter(srRelated != srRelated2) %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated2" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated2, RESOLUTION_SUMMARY)
```

```{r}
dup5 <- dup4 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  mutate(srRelated3 = str_extract_all(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  unnest_longer(srRelated3) %>% 
  mutate(srRelated3 = str_remove_all(srRelated3, "[^[:digit:]]"),
         srRelated3 = as.numeric(srRelated3)) %>% 
  distinct()

dup6 <- dup5 %>% 
  filter(INCIDENT_NUMBER != srRelated3) %>% 
  filter(srRelated != srRelated3) %>% 
  filter(srRelated2 != srRelated3) %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated3" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated3, RESOLUTION_SUMMARY.y.y)
```

```{r}
dup6U <- dup6 %>% 
  unite(2, 4, 6, 8, col = "RES_SUM", sep = " | ") %>% 
  nest(srRelated = c(3:5))

dup4U <- dup4 %>% 
  unite(2, 4, 6, col = "RES_SUM", sep = " | ") %>% 
  nest(srRelated = c(3, 4))

dup2U <- dup2 %>% 
  unite(2, 4, col = "RES_SUM", sep = " | ")

errU <- err %>% 
  unite(2, 4, col = "RES_SUM", sep = " | ")

dupdupU <- dupdup %>% 
  unite(2, 4, col = "RES_SUM", sep = " | ")

misU <- mis %>% 
  unite(2, 4, col = "RES_SUM", sep = " | ")
```

```{r}
dup46U <- rbind(dup4U, dup6U) %>% 
  unnest(srRelated) 

dup46ULong <- dup46U %>% 
  pivot_longer(3:5, values_to = "srRelated", values_drop_na = TRUE) %>% 
  unique()

dupU <- dup46ULong %>% 
  select(-name) %>% 
  rbind(dup2U, errU, dupdupU, misU)
```

```{r}
dupUXL <- dupU %>% 
  pivot_longer(cols = c(1,3), values_to = "srID") %>% 
  select(-name) %>% 
  unique()

dupUXL2 <- dupUXL %>% 
  separate_rows(RES_SUM, sep = "\\s\\|\\s") %>% 
  unique() %>% 
  group_by(srID) %>% 
  mutate(RES_SUM = str_flatten(RES_SUM, collapse = " | ")) %>% 
  unique()
```

omg I think i did it ðŸ˜­

## Summary

In this post, we began with 4,476 rows that refer to service request. Sometimes the referenced SR also referred to another SR. First we identified all unique SRs and their resolution summaries. Then, we joined the information, and linked it so each SR that referenced another SR showed the same resolution summary. In the end, we changed the resolution summary of 7,920 unique SRs.
