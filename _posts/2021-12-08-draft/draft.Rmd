---
title: "draft"
description: |
  A short description of the post.
author:
  - name: Sarah Johnson
    url: {}
date: 2021-12-08
output:
  distill::distill_article:
    self_contained: false
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

This is the third post in a series analyzing Memphis Code Enforcement data. In my [first post](https://sarahjohnson.io/posts/2021-12-03-311-data/) I introduced the dataset and walked through all 53 columns, discussing the purpose of each and which are or are not relevant to my analysis. In the [second post](https://sarahjohnson.io/posts/2021-12-04-311-data-2/) I began tidying the dataset to find service requests related to interior housing violations.

In this post I will conduct a basic word search of the dataset to understand what information is available.

## Getting Started

introduce what I'm doing here

```{r}
library(tidyverse)
```

Using the power of coding, let's combine some steps in the last post to quickly import our dataset, narrow our column selection, and filter for CE requests. If you would like to import the entire dataset, please see [the previous post](https://sarahjohnson.io/posts/2021-12-04-311-data-2/#getting-started).

```{r}
CE <-
  read_csv(
    "Service_Requests_since_2016.csv",
    col_types = cols(
      CLOSE_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      FOLLOWUP_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      LAST_MODIFIED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p"),
      REPORTED_DATE = col_datetime(format = "%m/%d/%Y %I:%M:%S %p")
    ),
    col_select = c(
      INCIDENT_NUMBER,
      DEPARTMENT,
      GROUP_NAME,
      REQUEST_TYPE,
      CE_CATEGORY,
      RESOLUTION_CODE:RESOLUTION_SUMMARY,
      REQUEST_STATUS,
      ADDRESS1,
      STREET_NAME,
      PARCEL_ID,
      REPORTED_DATE,
      FOLLOWUP_DATE,
      LAST_MODIFIED_DATE,
      CLOSE_DATE,
      OWNER_NAME,
      CREATED_BY_USER,
      REQUEST_PRIORITY,
      location1
    )
  ) %>%
  mutate(
    RESOLUTION_SUMMARY = str_to_lower(RESOLUTION_SUMMARY),
    STREET_NAME = str_to_upper(STREET_NAME),
    REQUEST_TYPE = str_to_lower(REQUEST_TYPE)
  ) %>%
  filter(DEPARTMENT == "Code Enforcement") %>%
  select(-DEPARTMENT)
```

Next, let's filter for relevant information.

I do this by deciding what is relevant and filtering out stuff that is not relevant (lol). First, here are the variables I've decided are relevant/not relevant.

```{r}
vHsg <- c("misc", "derelict") %>% str_c(collapse = "|")

vNotHsg <- c(
  "VOYC", "VOAR", "CVOAR", "CVOAT", "CVOYC", "COMMERCIAL", "STCLEANING",
  "mow", "commer[ci]*al", "vacant lot"
  ) %>% 
  str_c(collapse = "|")

vShelby <- c("SHELBY", "shelb[yh][ ]+c", "county", "limits") %>%
  str_c(collapse = "|") 

vDupe <- c("MCSC", "JA", "dup[li]*cate", "this a dup ") %>% 
  str_c(collapse = "|") 

vErr <- c(
  "(wrong|in[ ]?co[re]+ct|inaccurate|invalid|i[n]*suff[ic]*ent|bad|(could not|unable to|cant) (locate|find)|no such|not (a|an|the) (actual|valid|good|correct|physical))[ ]*(property|parcel)?[ ]*(a[d]+re[s]+|location)", 
  "a[d]+re[s]+[ ]*(was put in system wrong|does not ex[s]?ist|not valid(ated)?|(given|for this violation )?(is|was) incorrect)", 
  "correct address (of violation )?is",
  "(no)?[ ]*address[ ]*(not)?[ ]*found"
) %>%
  str_c(collapse = "|")
```

Note: for some reason the `vErr` section does not format correctly in these posts unless I manually break it up (otherwise the text goes off the side of the page). If you're copy and pasting the code, make sure to remove these breaks or the code will not catch everything.

Now let's create the tables.

```{r}
notHsg <- CE %>%
  filter(
    str_detect(RESOLUTION_CODE, vNotHsg) |
      str_detect(RESOLUTION_SUMMARY, vNotHsg) |
      !str_detect(REQUEST_TYPE, vHsg)
  )

hsg <- CE %>% 
  anti_join(notHsg, by = "INCIDENT_NUMBER")

shelby <- hsg %>%
  filter(str_detect(RESOLUTION_CODE, vShelby) |
           str_detect(RESOLUTION_SUMMARY, vShelby)) 

dupes <- hsg %>% 
  filter(str_detect(GROUP_NAME, vDupe) |
           str_detect(RESOLUTION_CODE, vDupe) |
           str_detect(RESOLUTION_SUMMARY, vDupe)) 

dupes2 <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) 

err <- hsg %>%
  filter(str_detect(RESOLUTION_SUMMARY, vErr) |
           RESOLUTION_CODE == "INSUF" |
           REQUEST_STATUS == "Back to Department")
```

<!--# maybe just group them all together into notHsg? -->

```{r}
hsg <- CE %>% 
  anti_join(notHsg, by = "INCIDENT_NUMBER") %>% 
  anti_join(shelby, by = "INCIDENT_NUMBER") %>% 
  anti_join(dupes, by = "INCIDENT_NUMBER") %>% 
  anti_join(dupes2, by = "INCIDENT_NUMBER") %>% 
  anti_join(err, by = "INCIDENT_NUMBER") %>% 
  select(-c(GROUP_NAME, REQUEST_TYPE))
```

As in our last post, the hsg table has 17 columns and 46,182 rows.

## Word Search

Do you like word searches? Because that's the only way to learn anything from this dataset.

### Tenant

let's find words! tenant, occupant, resident

```{r}
vTenant <- c(
  "\\b(tob)?t[aent]*t(s|ed)?",
  "resident(s)?",
  "tensnt(s)?",
  "o[cu]+pant(s)?",
  "tenate\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

tenant <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vTenant))
```

There are 2,025 rows which mention some form of tenant, resident, or occupant.

```{r}
vApt <- c(
  "\\bapartment",
  "apt",
  "unit\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

apt <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vApt))
```

619

```{r}
vFurnish <- c(
  "\\btoilet",
  "tub",
  "fridge",
  "refrigerator",
  "ceiling",
  "sink",
  "cabinets",
  "heating",
  "living( )?room",
  "carpet",
  "bed bug",
  "kitchen",
  "hallway",
  "stove\\b"
) %>% 
  str_c(collapse = "\\b|\\b")

furnish <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, vFurnish))
```

316

```{r}
hsg3 <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, c(vTenant, vApt, vFurnish)))
```

<!--# error -->

### Moved

Just looking at the dataset, it appears many of the service requests have been closed out because the resident moved. Let's see how many times the words moved/moving appear.

```{r}
moved <- tenant %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\bmoved|\\bmoving"))
```

400! 20% of cases mentioning tenants are closed because the tenant moved! One in five! Jesus christ!

The problem is not being solved! The tenants are just leaving and keeping the problem open for the next tenants.

### Mold

What about mold?

```{r}
mold <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\bmold"))
```

109, or 5%

## DUPLICATES

Duplicates

```{r}
dupes <- hsg %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  select(INCIDENT_NUMBER, RESOLUTION_SUMMARY) %>% 
  mutate(srRelated = str_extract(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b"),
         srRelated = str_remove_all(srRelated, "[^[:digit:]]"),
         srRelated = as.numeric(srRelated)) %>% 
  filter(srRelated != INCIDENT_NUMBER)
```

```{r}
dupes2 <- dupes %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated, RESOLUTION_SUMMARY.y)
```

```{r}
dupes3 <- dupes2 %>% 
  mutate(srRelated2 = str_extract(RESOLUTION_SUMMARY.y, "\\b[sr #]*\\d{7,8}\\b"),
         srRelated2 = str_remove_all(srRelated2, "[^[:digit:]]"),
         srRelated2 = as.numeric(srRelated2)) %>% 
  filter(!is.na(srRelated2)) %>% 
  filter(srRelated2 != srRelated) %>% 
  filter(srRelated2 != INCIDENT_NUMBER)
```

```{r}
dupes4 <- dupes3 %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated2" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated2, RESOLUTION_SUMMARY)
```

```{r}
dupes5 <- dupes4 %>% 
  mutate(srRelated3 = str_extract(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b"),
         srRelated3 = str_remove_all(srRelated3, "[^[:digit:]]"),
         srRelated3 = as.numeric(srRelated3)) %>% 
  filter(!is.na(srRelated3)) %>% 
  filter(srRelated3 != srRelated2) %>% 
  filter(srRelated3 != srRelated) %>% 
  filter(srRelated3 != INCIDENT_NUMBER)
```

```{r}
dupes6 <- dupes5 %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated3" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated3, RESOLUTION_SUMMARY.y.y)
```

<!--# extract_all and unnest -->

```{r}
ressum <- dup %>% 
  distinct()

misres <- dup %>% 
  group_by(INCIDENT_NUMBER, RESOLUTION_SUMMARY, srRelated) %>% 
  mutate(num_dups = n(), 
         dup_id = row_number()) %>% 
  ungroup() %>% 
  mutate(is_duplicated = dup_id > 1)


```

```{r}
dupUnite <- dup2 %>% 
  unite(RESOLUTION_SUMMARY.x, RESOLUTION_SUMMARY.y, col = "RES_SUM", sep = " | ") 
```

```{r}
dup3 <- dup2 %>% 
  filter(str_detect(RESOLUTION_SUMMARY.y, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  mutate(srRelated2 = 
           str_extract_all(RESOLUTION_SUMMARY.y, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  unnest_longer(srRelated2) %>% 
  mutate(srRelated2 = str_remove_all(srRelated2, "[^[:digit:]]"),
         srRelated2 = as.numeric(srRelated2))
```

```{r}
dup4 <- dup3 %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated2" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated2, RESOLUTION_SUMMARY) %>% 
  filter(srRelated2 != srRelated) %>% 
  filter(srRelated2 != INCIDENT_NUMBER)
```

```{r}
dup5 <- dup4 %>% 
  filter(str_detect(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  mutate(srRelated3 = 
           str_extract_all(RESOLUTION_SUMMARY, "\\b[sr #]*\\d{7,8}\\b")) %>% 
  unnest_longer(srRelated3) %>% 
  mutate(srRelated3 = str_remove_all(srRelated3, "[^[:digit:]]"),
         srRelated3 = as.numeric(srRelated3))
```

```{r}
dup6 <- dup5 %>% 
  inner_join(Service_Requests_since_2016, by = c("srRelated2" = "INCIDENT_NUMBER")) %>% 
  select(INCIDENT_NUMBER:srRelated3, RESOLUTION_SUMMARY.y.y)
```
