---
title: "311-data-5"
description: |
  A short description of the post.
author:
  - name: Sarah Johnson
    url: {}
date: 2022-01-22
output:
  distill::distill_article:
    self_contained: false
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Distill is a publication format for scientific and technical writing, native to the web.

Learn more about using Distill at <https://rstudio.github.io/distill>.

## Starting Code

Import dataset

```{r}
library(tidyverse)

zService_Requests_since_2016 <-
  read_csv("../_data/Service_Requests_since_2016.csv") %>% 
  mutate(RESOLUTION_SUMMARY = str_to_lower(RESOLUTION_SUMMARY),
         RESOLUTION_CODE = str_to_lower(RESOLUTION_CODE),
         RESOLUTION_CODE_MEANING = str_to_lower(RESOLUTION_CODE_MEANING))
```

Filter for CE

```{r}
zCE <- zService_Requests_since_2016 %>%
  filter(DEPARTMENT == "Code Enforcement" &
           str_detect(REQUEST_TYPE, "Misc|Derelict")) %>%
  select(sr = INCIDENT_NUMBER,
         rc = RESOLUTION_CODE,
         rcm = RESOLUTION_CODE_MEANING,
         rs = RESOLUTION_SUMMARY) %>%
  filter(!is.na(rs))
```

Extract numbers

```{r}
vSR <- c(
  "\\b(sr)?\\d{7}\\b",
  "(please )?(see|(ref|refer|reference)\\b( to)?)?( )?(\\b(see)?s[/ \\.]*r\\b|service request|ticket)( )?(#)?( )?(\\.)?",
  "(please )?(see|(ref|refer|reference)\\b( to)?|reference)( )?(#)?( )?(\\.)?"
) %>% 
  str_c(collapse = "|")

vMonths <-
  c("january", "february", "march", "april", 
    "may", "june", "july", "august", 
    "september", "october", "november", "december",
    str_c("\\b",
      c("jan", "feb", "mar", "apr", "jun", "jul", 
        "aug", "sept", "oct", "nov", "dec"),
      "(\\.)?\\b"
      )
    )

vDate <- c(
  "\\b\\d{1,2}(:\\d{2})?(:\\d{2})?( )?(a(\\.)?m(\\.)?|p(\\.)?m(\\.)?)",
  str_c(vMonths, "( )?", "\\d{1,2}", "(nd|th|rd)?", "((,)?( )?\\d{2,4})?"),
  str_c("\\d{1,2}", "(nd|th|rd)? ", vMonths, "((,)?( )?\\d{2,4})?"),
  str_c("\\d{1,2}", "\\W", vMonths, "\\W", "\\d{2,4}"),
  str_c("\\d{1,2}", "(nd|th|rd)?", " of ", vMonths),
  "(?<=(\\b|\\D))\\d{1,2}( )?\\W{1,2}\\d{1,2}( )?\\W( )?\\d{2}(?=\\b|\\D)",
  "(?<=(\\b|\\D))\\d{1,2}( )?\\W\\d{1,2}\\W( )?\\d{4}",
  "\\b\\d{1,2}\\W{1,2}\\d{1,2}\\b",
  "\\b\\d{1,2}\\W\\d{4}\\b"
  ) %>%
  str_c(collapse = "|")

vTax <- "(?<=tax sale( (number|2019))? )\\d{2}(\\.)?\\d{2}(?!(\\W)?\\d)"
```

As mentioned in the last post, I am hiding the code used to extract phone numbers from blog posts due to privacy concerns.

```{r include=FALSE}
vPH <- "(ph)?[# ]*(\\d{3}\\W)?\\b\\d{3}\\b\\W\\d{4}"
```

<!--# talk about removing non-word characters -->

```{r}
zNumbers <- zCE %>%
  mutate(
    ref = str_extract_all(rs, "\\b(sr)?\\d{7}\\b"),
    rs = case_when(
      str_detect(rs, "\\b(sr)?\\d{7}\\b") ~ str_replace_all(rs, vSR, " "),
      TRUE ~ rs
    ),
    taxSale = str_extract(rs, vTax),
    rs = str_remove(rs, vTax),
    date = str_extract_all(rs, vDate),
    rs = str_remove_all(rs, vDate),
    ph = str_extract_all(rs, vPH),
    rs = str_remove_all(rs, vPH),
    rs = str_replace_all(rs, "\\W", " "),
    rc = str_replace_all(rc, "\\W", " "),
    rcm = str_replace_all(rcm, "\\W", " "),
    rs = str_squish(rs),
    rc = str_squish(rc),
    rcm = str_squish(rcm),
    rs = na_if(rs, "")
  )
```

Since I'm cleaning up the resolution summary and resolution codes, I can remove rows where these columns are *NA*.

```{r}
zNum <- zNumbers %>% 
  filter(!is.na(rs) & !is.na(rc))
```

```{r}
zNum %>% count(rs) %>% arrange(desc(n))
```

<!--# clean up RC -->

```{r}
zRC0 <- zNum %>% 
  select(rc, rcm) %>% 
  pivot_longer(cols = c(rcm, rc), names_to = "remo", values_to = "rcs") %>% 
  select(rcs) %>% 
  filter(rcs != "shelby") %>% 
  distinct()

vRC0 <- zRC0$rcs

vRC1 <- c(
  #' existing code, minor changes
  "active npa case",
  "npa active",
  "(complaint )?not justified",
  "please contact (the )?(shelby )?county (land bank )?(at )?for (further information|additional assistance)",
  "(shelby )?county (own(ed)? )?property",
  "scop",
  "justified active",
  "dismissed",
  "no cooperation",
  "(property )?(demolish(ed)?|rehab(ilitat|b)(ed|ion)|boarded)( by (the )?owner)?( and occupied)?",
  "npa court order demo",
  "jw(dm|rh)",
  "\\b(cvob|vo)\\b",
  #' new codes
  "(the|all)?( )?(code )?(violation(s)?|issues) ((has|have) been )?(corrected|resolved|repaired|removed)",
  "repairs (have been|were)?( )?made",
  "(the)?( )?(yard|property)?( )?(was )?(not )?(in)?( )?compl(ia|ai)n(ce|t)",
  "(there (were|was))?( )?no(t in)? (code )?violation(s)?( )?(were|was)?( )?(present|found|observed)?",
  "no(t a)? (housing )?(code|grass|yard|vehicle) violation",
  "(property )?(is|has been)?( )?(occupied|secured|vacant)( lot)?",
  "(corrected|resolved|repaired|removed)",
  "all is ok",
  "mowed",
  "(property|grass|yard) (has been|was)?( )?(cut|clean(ed)?)( up)?",
  "(the )?vehicle(s)? (was)?removed",
  "created in error",
  "training",
  "wrong address",
  "duplicate",
  "(will )?(be )?(re)?(issue|create)(d)?( new sr)?(if required)?",
  "condemnation hearing",
  "move to condemnation department",
  "(property )?written up for demolition",
  "administrative referral",
  "commercial( property)?",
  "(shelby county )?tax sale",
  "(could not|no) access (to )?(the )?property",
  "no response",
  "tenant(s)? (has )?moved",
  "new owner(ship)?",
  "closed( violation)?( out)?"
  )

vRC <- str_c("\\b", c(vRC0, vRC1), "\\b") %>% str_c(collapse = "|")
```

and then

```{r}
zRC <- zNum %>%
  mutate(
    rc2 = str_extract_all(rs, vRC),
    rs = str_remove_all(rs, vRC),
    rs = str_squish(rs),
    rs = na_if(rs, "")
  )
```

```{r}
todo <- zRC %>% filter(!is.na(rs))
```

## Events and Inspectors

```{r}
todo %>% count(rs) %>% arrange(desc(n))
```

```{r}
vRoles <- str_c("(per )?", c("insp(ector)?(?!ection)",
                          "sup(ervisor)?",
                          "tenant",
                          "citizen")) %>% str_c(collapse = "|")
  
```

```{r}
todo %>% filter(str_detect(rs, vRoles)) %>% count(rs) %>% arrange(desc(n))
```

```{r}
roles <- todo %>% 
  mutate(
    role = str_extract_all(rs, vRoles),
    rs = str_remove_all(rs, vRoles),
    rs = str_squish(rs),
    rs = na_if(rs, "")
  )

roles %>% count(rs) %>% arrange(desc(n))
```

```{r}
vInspectors <- str_c("(per )?", "\\b", c(
  "(c|cheryl)?( )?clausel",
  "(q|quatarious)?( )?gilc(l)?hrest",
  "(r|robert)?( )?gray",
  "(j|judith)?( )?norman",
  "[amw]?( )?lewis( nickson)?",
  "[arc]?( )?hill",
  "[dr]?( )?butler",
  "[ej]?( )?cooper",
  "[al]?( )?davis",
  "[ja]*( )?irwin",
  "[ce]?( )?jones",
  "[rn]?( )?rashada",
  "[rd]?( )?witter",
  "[ac]?( )?wi[li]*am(s)?",
  "(e)?( )?blow",
  "(k)?( )?boone",
  "(c)?( )?boykins",
  "(b)?( )?bratten",
  "(r)?( )?brown",
  "(c)?( )?bryant",
  "(s)?( )?burgess",
  "(d)?( )?burton",
  "(l)?( )?busby",
  "(t)?( )?cobb",
  "(a)?( )?collins",
  "(s)?( )?echols",
  "(v)?( )?ervin",
  "(t)?( )?fry",
  "(s)?( )?gaspar",
  "(j)?( )?golden",
  "(d)?( )?grafton",
  "(c)?( )?higgenbottom",
  "(s)?( )?howell",
  "(j)?( )?hymon",
  "(j)?( )?jackson",
  "(m)?( )?james",
  "(r)?( )?lake",
  "(d)?( )?massey",
  "(m)?( )?middlebrooks",
  "(s)?( )?milan",
  "(d)?( )?mi(t)?chell",
  "(j)?( )?mos[lbe]*y",
  "(v)?( )?moses",
  "(t)?( )?neff",
  "(r)?( )?nelson",
  "(t)?( )?norwood",
  "(b)?( )?pa(t)+erson", 
  "(k)?( )?payne",
  "(r)?( )?peete(e)?",
  "(t)?( )?pegues",
  "(a)?( )?powell",
  "(m)?( )?pruitt",
  "(s)?( )?rice",
  "(t)?( )?richardson",
  "(c)?( )?sager",
  "(r)?( )?sherrell",
  "(b)?( )?smith",
  "(t)?( )?strong",
  "(m)?( )?tay(h)?lor",
  "(c)?( )?thom(a)?s",
  "(j)?( )?tumbrink",
  "(p)?( )?tyler",
  "(j)?( )?walker",
  "(m)?( )?ward",
  "(k)?( )?washington",
  "(b)?( )?woodland",
  "(v)?( )?woods",
  "ch[am]*bers",
  "ferguson",
  "funches",
  "griffin",
  "johnson",
  "judy",
  "lynum",
  "rimmer",
  "tidwell",
  "tyrone",
  "waler",
  "jn", #' judith norman
  "ma",
  "sh(?! e )" #' s howell
), "\\b") %>% 
  str_c(collapse = "|")

```

```{r}
insp <- roles %>% 
  mutate(
    role = str_extract_all(rs, vInspectors),
    rs = str_remove_all(rs, vInspectors),
    rs = str_squish(rs),
    rs = na_if(rs, "")
  )
```

```{r}
todo2 <- insp %>% 
  filter(!is.na(rs))

todo2 %>% count(rs) %>% arrange(desc(n))
```

## TO DO

```{r}
vEve <- c(
  "at (the )?time of (the|this)?( )?((re)?( )?insp(ection)?|recheck)",
  "(per|upon|during|prior to) inspection",
  "[1-3](st|nd|rd)? attempt(s)?",
  "\\bf( )?u\\b( inspection)?"
) %>% str_c(collapse = "|")

eve <- todo %>% 
  mutate(
    event = str_extract_all(rs, vEve),
    rs = str_remove_all(rs, vEve),
    rs = str_squish(rs),
    rs = na_if(rs, "")
  )

eve2 <- eve %>% 
  filter(!is.na(rs))
```

```{r}
eve2 %>% count(rs) %>% arrange(desc(n))
```

```{r}
pers <- zNum %>% 
  mutate(
    person = str_extract_all(rs, vInspectors),
    rs = str_remove_all(rs, vInspectors),
    rs = str_squish(rs),
    rs = na_if(rs, "")
  )

pers2 <- pers %>% 
  filter(!is.na(rs))

pers2 %>% count(rs) %>% arrange(desc(n))
```

```{r}
pers <- roles %>% 
  mutate(
    person = str_extract_all(rs, vInspectors),
    rs = str_remove_all(rs, vInspectors),
    rs = str_squish(rs),
    rs = na_if(rs, "")
  )

pers2 <- pers %>% 
  filter(!is.na(rs))

pers2 %>% count(rs) %>% arrange(desc(n))
```

```{r}
td <- pers2 %>% count(rs) %>% arrange(desc(n))
```
