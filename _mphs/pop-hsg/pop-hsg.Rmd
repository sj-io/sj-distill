---
title: "Population and Housing"
description: |
  Census data for Memphis, Shelby County, and the Memphis MSA.
author:
  - name: Sarah Johnson
date: 2022-06-20
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(tidycensus)
library(gt)
```

```{r eval=FALSE, include=FALSE}
v20 <- load_variables(2020, "acs5")

yrs <- c(2010, 2020)
```

```{r eval=FALSE, include=FALSE}
hsgMphs <- map_dfr(yrs, ~ {
  get_acs(geography = "place",
                state = "TN",
                table = "B25002",
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis")) 

hsgSh <- map_dfr(yrs, ~ {
  get_acs(geography = "county",
                state = "TN", county = "Shelby",
                table = "B25002",
                year = .x,
                cache_table = TRUE)
}, .id = "year")

hsgMSA <- map_dfr(yrs, ~ {
  get_acs(geography = "cbsa",
                table = "B25002",
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis"))
```

```{r eval=FALSE, include=FALSE}
hsg <- rbind(hsgMphs, hsgSh, hsgMSA) %>% 
  mutate(year = recode(year, '1' = 2010, '2' = 2020),
         variable = recode(variable,
                           'B25002_001' = 'Total Housing Units',
                           'B25002_002' = 'Occupied Units',
                           'B25002_003' = 'Vacant Units'),
         NAME = recode(NAME, 
                       'Memphis city, Tennessee' = 'Memphis',
                       'Shelby County, Tennessee' = 'Shelby County',
                       'Memphis, TN-MS-AR Metro Area' = 'Memphis Metro')) 

hsg$NAME <- factor(hsg$NAME, 
                   levels = c(
                     'Memphis', 'Shelby County', 'Memphis Metro'))
```

```{r eval=FALSE, include=FALSE}
popMphs <- map_dfr(yrs, ~ {
  get_acs(geography = "place",
                state = "TN",
                variables = "B25008_001",
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis")) 

popSh <- map_dfr(yrs, ~ {
  get_acs(geography = "county",
                state = "TN", county = "Shelby",
                variables = "B25008_001",
                year = .x,
                cache_table = TRUE)
}, .id = "year")

popMSA <- map_dfr(yrs, ~ {
  get_acs(geography = "cbsa",
                variables = "B25008_001",
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis"))
```

```{r eval=FALSE, include=FALSE}
pop <- rbind(popMphs, popSh, popMSA) %>% 
  mutate(year = recode(year, '1' = 2010, '2' = 2020),
         variable = recode(variable,
                           'B25008_001' = 'Pop in Housing Units'),
         NAME = recode(NAME, 
                       'Memphis city, Tennessee' = 'Memphis',
                       'Shelby County, Tennessee' = 'Shelby County',
                       'Memphis, TN-MS-AR Metro Area' = 'Memphis Metro')) 

pop$NAME <- factor(pop$NAME, 
                   levels = c(
                     'Memphis', 'Shelby County', 'Memphis Metro'))
```

```{r eval=FALSE, include=FALSE}
pophsg <- rbind(pop, hsg) %>% 
  group_by(NAME, variable) %>% 
  mutate(pct_chg = (estimate/lag(estimate) - 1)) %>% 
  filter(!is.na(pct_chg)) %>% 
  select(-c(year, GEOID, moe)) %>% ungroup() 
```

```{r eval=FALSE, include=FALSE}
write_csv(pophsg, "../_data/pophsg.csv")
```


```{r}
pophsg <- read_csv("../_data/pophsg.csv")
```


```{r}
total <- pophsg %>% 
  filter(variable == "Pop in Housing Units" | 
           variable == "Occupied Units") %>% 
  mutate(variable = recode(variable, 
         'Pop in Housing Units' = 'Population',
         'Occupied Units' = 'Households'))

hsgtbl <- pophsg %>% 
  filter(str_detect(variable, "Units") & !str_detect(variable, "Pop"))
```

```{r layout='l-page'}
total %>% 
  pivot_wider(names_from = NAME, 
              values_from = c(estimate, pct_chg)) %>% 
  gt() %>% 
  tab_spanner(
    label = "Memphis",
    columns = c(estimate_Memphis, pct_chg_Memphis)
  ) %>% 
  tab_spanner(
    label = "Shelby County",
    columns = c('estimate_Shelby County', 'pct_chg_Shelby County')
  ) %>% 
  tab_spanner(
    label = "Memphis Metro",
    columns = c('estimate_Memphis Metro', 'pct_chg_Memphis Metro')
  ) %>% 
  fmt_percent(columns = c(
    'pct_chg_Memphis',
    'pct_chg_Shelby County',
    'pct_chg_Memphis Metro'
    )) %>% 
  fmt_number(columns = c(
    'estimate_Memphis', 
    'estimate_Shelby County',
    'estimate_Memphis Metro'),
    decimals = 0) %>% 
  cols_label(
    'estimate_Memphis' = '2020',
    'pct_chg_Memphis' = '2010-2020',
    'estimate_Shelby County' = '2020', 
    'pct_chg_Shelby County' = '2010-2020',
    'estimate_Memphis Metro' = '2020', 
    'pct_chg_Memphis Metro' = '2010-2020',
    'variable' = ' '
  ) %>% 
  tab_footnote(
    footnote = "Population is the Total Population in Occupied Housing, which excludes people living in group quarters."
  ) %>% 
  tab_footnote(
    footnote = "Source: ACS 5-Year 2005-2010 & 2015-2020"
  ) %>% 
  tab_header(
    title = "Population and Households in Memphis Area"
  )
```

```{r layout='l-page'}
hsgtbl %>% 
  pivot_wider(names_from = NAME, 
              values_from = c(estimate, pct_chg)) %>% 
  gt() %>% 
  tab_spanner(
    label = "Memphis",
    columns = c(estimate_Memphis, pct_chg_Memphis)
  ) %>% 
  tab_spanner(
    label = "Shelby County",
    columns = c('estimate_Shelby County', 'pct_chg_Shelby County')
  ) %>% 
  tab_spanner(
    label = "Memphis Metro",
    columns = c('estimate_Memphis Metro', 'pct_chg_Memphis Metro')
  ) %>% 
  fmt_percent(columns = c(
    'pct_chg_Memphis',
    'pct_chg_Shelby County',
    'pct_chg_Memphis Metro'
    )) %>% 
  fmt_number(columns = c(
    'estimate_Memphis', 
    'estimate_Shelby County',
    'estimate_Memphis Metro'),
    decimals = 0) %>% 
  cols_label(
    'estimate_Memphis' = '2020',
    'pct_chg_Memphis' = '2010-2020',
    'estimate_Shelby County' = '2020', 
    'pct_chg_Shelby County' = '2010-2020',
    'estimate_Memphis Metro' = '2020', 
    'pct_chg_Memphis Metro' = '2010-2020',
    'variable' = ' '
  ) %>% 
  tab_footnote(
    footnote = "Source: ACS 5-Year 2005-2010 & 2015-2020"
  ) %>% 
  tab_header(
    title = "Housing Units in Memphis Area"
  )
```
