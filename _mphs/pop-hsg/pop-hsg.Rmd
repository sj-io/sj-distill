---
title: "Population and Housing"
description: |
  Census data for Memphis, Shelby County, and the Memphis MSA.
author:
  - name: Sarah Johnson
date: 2022-06-20
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(tidycensus)
library(plotly)
library(gt)
```

```{r}
v20 <- load_variables(2020, "acs5")

yrs <- c(2010, 2015, 2020)
```

```{r}
hsgMphs <- map_dfr(yrs, ~ {
  get_acs(geography = "place",
                state = "TN",
                table = "B25002",
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis")) 

hsgSh <- map_dfr(yrs, ~ {
  get_acs(geography = "county",
                state = "TN", county = "Shelby",
                table = "B25002",
                year = .x,
                cache_table = TRUE)
}, .id = "year")

hsgMSA <- map_dfr(yrs, ~ {
  get_acs(geography = "cbsa",
                table = "B25002",
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis"))
```

```{r}
hsg <- rbind(hsgMphs, hsgSh, hsgMSA) %>% 
  mutate(year = recode(year, '1' = 2010, '2' = 2015, '3' = 2020),
         variable = recode(variable,
                           'B25002_001' = 'Total Housing Units',
                           'B25002_002' = 'Occupied Units',
                           'B25002_003' = 'Vacant Units'),
         NAME = recode(NAME, 
                       'Memphis city, Tennessee' = 'Memphis',
                       'Shelby County, Tennessee' = 'Shelby County',
                       'Memphis, TN-MS-AR Metro Area' = 'Memphis Metro')) 

hsg$NAME <- factor(hsg$NAME, 
                   levels = c(
                     'Memphis', 'Shelby County', 'Memphis Metro'))
```

```{r layout = 'l-page'}
gg <- hsg %>% 
  filter(variable != 'Total Housing Units') %>% 
  ggplot(aes(x = year, y = estimate, fill = variable)) +
  geom_area(show.legend = FALSE) +
  facet_wrap(~NAME) +
  labs(x = "Year",
       y = "Estimate",
       title = "Total Housing Units in Memphis area") +
  scale_x_continuous(breaks = c(2010, 2015, 2020)) +
  scale_y_continuous(labels = scales::comma)

ggplotly(gg)
```

```{r}
popMphs <- map_dfr(yrs, ~ {
  get_acs(geography = "place",
                state = "TN",
                variables = c("B26001_001", "B25008_001"),
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis")) 

popSh <- map_dfr(yrs, ~ {
  get_acs(geography = "county",
                state = "TN", county = "Shelby",
                variables = c("B26001_001", "B25008_001"),
                year = .x,
                cache_table = TRUE)
}, .id = "year")

popMSA <- map_dfr(yrs, ~ {
  get_acs(geography = "cbsa",
                variables = c("B26001_001", "B25008_001"),
                year = .x,
                cache_table = TRUE)
}, .id = "year") %>% 
  filter(str_detect(NAME, "Memphis"))
```

```{r}
pop <- rbind(popMphs, popSh, popMSA) %>% 
  mutate(year = recode(year, '1' = 2010, '2' = 2015, '3' = 2020),
         variable = recode(variable,
                           'B25008_001' = 'Pop in Housing Units',
                           'B26001_001' = 'Group Quarters Pop'),
         NAME = recode(NAME, 
                       'Memphis city, Tennessee' = 'Memphis',
                       'Shelby County, Tennessee' = 'Shelby County',
                       'Memphis, TN-MS-AR Metro Area' = 'Memphis Metro')) 

pop$NAME <- factor(pop$NAME, 
                   levels = c(
                     'Memphis', 'Shelby County', 'Memphis Metro'))
pop$variable <- factor(pop$variable, levels = c(
  'Pop in Housing Units', 'Group Quarters Pop'
))
```

```{r layout = 'l-page'}
gg2 <- pop %>% 
  ggplot(aes(x = year, y = estimate, fill = variable)) +
  geom_area(show.legend = FALSE) +
  facet_wrap(~NAME) +
  labs(x = "Year",
       y = "Estimate",
       title = "Population in Memphis area") +
  scale_x_continuous(breaks = c(2010, 2015, 2020)) +
  scale_y_continuous(labels = scales::comma)

ggplotly(gg2)
```

```{r}
pophsg <- rbind(pop, hsg) %>% 
  filter(year != "2015") %>% 
  group_by(NAME, variable) %>% 
  mutate(pct_chg = (estimate/lag(estimate) - 1)) %>% 
  filter(!is.na(pct_chg)) %>% 
  select(-c(year, GEOID, moe)) %>% ungroup() %>% 
  filter(variable == "Pop in Housing Units" | variable == "Occupied Units") %>% 
  mutate(variable = recode(variable, 
         'Pop in Housing Units' = 'Population',
         'Occupied Units' = 'Households'))
```

```{r}
pophsg %>% 
  pivot_wider(names_from = NAME, 
              values_from = c(estimate, pct_chg)) %>% 
  gt() %>% 
  tab_spanner(
    label = "Memphis",
    columns = c(estimate_Memphis, pct_chg_Memphis)
  ) %>% 
  tab_spanner(
    label = "Shelby County",
    columns = c('estimate_Shelby County', 'pct_chg_Shelby County')
  ) %>% 
  tab_spanner(
    label = "Memphis Metro",
    columns = c('estimate_Memphis Metro', 'pct_chg_Memphis Metro')
  ) %>% 
  fmt_percent(columns = c(
    'pct_chg_Memphis',
    'pct_chg_Shelby County',
    'pct_chg_Memphis Metro'
    )) %>% 
  fmt_number(columns = c(
    'estimate_Memphis', 
    'estimate_Shelby County',
    'estimate_Memphis Metro'),
    decimals = 0) %>% 
  cols_label(
    'estimate_Memphis' = '2020',
    'pct_chg_Memphis' = '2010-2020',
    'estimate_Shelby County' = '2020', 
    'pct_chg_Shelby County' = '2010-2020',
    'estimate_Memphis Metro' = '2020', 
    'pct_chg_Memphis Metro' = '2010-2020',
    'variable' = ' '
  ) %>% 
  tab_footnote(
    footnote = "Population is the Total Population in Occupied Housing, which excludes people living in group quarters."
  ) %>% 
  tab_footnote(
    footnote = "Source: ACS 5-Year 2005-2010 & 2015-2020"
  ) %>% 
  tab_header(
    title = "Population and Households in Memphis Area"
  )
```
